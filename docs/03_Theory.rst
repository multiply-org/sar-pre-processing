Processing Chain
================

.. code::

    put "Sentinel-1 Level-1 SLC data" in the caption ???

Overview
--------
The two Sentinel-1 satellites A and B are one of the first satellites which are providing microwave data with a high temporal and spatial resolution. Within the MULTIPLY project we developed a preprocessing chain to to use time-series of Sentinel-1 data for quantitative analysis of vegetation and soil parameters over agricultural fields. Therefore rigorous geometric and radiometric corrections as well as a multi-temporal speckle filter is applied on the data. The different preprocessing steps are shown in :numref:`work_flow_step_1` and :numref:`work_flow_step_2`. Furthermore, every processing step is explained in more detail in different subsections. As you can see in :numref:`work_flow_step_1` and :numref:`work_flow_step_2` the preprocessing work-flow is split in two main parts. The preprocessing operations in :numref:`work_flow_step_1` can be applied separately for every image. Whereas the work-flow shown in :numref:`work_flow_step_2` need several images which were preprocessed by the different steps presented in :numref:`work_flow_step_1`.

The whole preprocessing chain for Sentinel-1 Level-1 Single Look Complex (SLC) data is accomplished by ESA's SNAP S1TBX software (current version 5.0.4). The SNAP toolbox can be downloaded from `<http://step.esa.int/main/download/>`_. However, to automatically apply different preprocessing steps on Sentinel-1 data a python script was written which uses the Graph Processing Tool (GPT) of the S1TBX.

.. _work_flow_step_1:
.. figure:: images/flow_chard.png
    :align: center
    :width: 80%

    First main part of the used preprocessing chain (rigorous geometric and radiometric correction including preliminary operations)

.. _work_flow_step_2:
.. figure:: images/flow_chard_01.png
    :align: center
    :width: 80%

    Second main part of the used preprocessing chain (Co-registration and multi-temporal speckle filter)


Sentinel-1 Level-1 SLC data
---------------------------
The preprocessing work-flow of :numref:`work_flow_step_1` is based on Sentinel-1 Level-1 SLC data. Among some other sources Sentinel-1 data can be downloaded from ESA's Copernicus Open Access Hub `<https://scihub.copernicus.eu/>`_.


Sentinel-1 Level-1 SLC data are generated by the operational ESA Instrument Processing Facility (IPF). The SLC products are situated in slant range geometry. The slant range geometry is the natural radar one and is defined by the line-of-sight distance of the radar system to each reflecting object. The SLC product consists of focused SAR data in zero-Doppler orientation. Furthermore the SAR data is geo-referenced by using orbit and attitude information directly provided by the satellite and is corrected for errors caused by the well known azimuth bi-static delay, elevation antenna pattern and range spreading loss. In contrary to Level-1 Ground Range Detected (GRD) products SLC data preserve the real and imaginary part of the backscatter signal and contain therefore also the phase information :cite:`Sentinel1Team`. For all available acquisition modes (StripMap, Interferometric Wide, Extra Wide, and Wave) SLC products are generated by the IPF.

For further information about Sentinel-1 Level-1 products please have a look at :cite:`Sentinel1Team` available at `<https://earth.esa.int/documents/247904/685163/Sentinel-1_User_Handbook>`_.


Precise orbit file
-------------------
Theory / Purpose
~~~~~~~~~~~~~~~~~~

During the acquisition of Sentinel-1 data the satellite position is recorded by a Global Navigation Satellite System (GNSS). To assure a fast delivery of Sentinel-1 products orbit information generated by an on-board navigation solution are stored within the Sentinel-1 Level-1 products. The orbit positions are later refined and made available as restituted or precise orbit files by the Copernicus Precise Orbit Determination (POD) Service. The POD products for Sentinel-1 data with there accuracy and availability after data acquisition are listed in :numref:`POD_table`.

.. _POD_table:
.. table:: Summary of accuracy specification for Sentinel-1 POD products :cite:`SentinelsPODteam`
    :widths: auto

    +------------+--------------------------------------------+-------------+----------+
    |   Mission  | POD Product                                | Accuracy    | Latency  |
    +------------+--------------------------------------------+-------------+----------+
    |            | Restituted Orbit File                      | < 10 cm     | 3 hours  |
    |            +--------------------------------------------+-------------+----------+
    | Sentinel-1 | Precise Orbit Ephemerides (POE) Orbit file | < 5 cm      | 20 days  |
    |            +--------------------------------------------+-------------+----------+
    |            | Attitude Restituted Data                   | < 0.005 deg | 20 days  |
    +------------+--------------------------------------------+-------------+----------+

Precise orbit information can have a high influence on the quality of several different preprocessing steps. Therefore always the most accurate orbit information should be used.

Practical implementation
~~~~~~~~~~~~~~~~~~~~~~~~~
Since the preprocessing for the MULTIPLY project doesn't depend on near-real-time data the in less then 20 provided precise orbit file and if not available the restituted orbit file is used to update the orbit and velocity information within the Sentinel-1 SLC product. Therefore the operator "Apply Orbit Correction" within SNAP S1TBX is used.

Input:
    - Sentinel-1 SLC IW image (downloaded from Copernicus Open Access Hub)
    - precise orbit file (automatic download)

Output:
    - Sentinel-1 SLC IW image with updated orbit information

.. code::

    ??? genauer auf die Processing Parameters in SNAP eingehen (polynominal degree)

Thermal noise removal
---------------------
Theory / Purpose
~~~~~~~~~~~~~~~~~~
Thermal noise is caused by the background energy of a SAR receiver and independent from the received signal power. Like some other noise factors thermal noise appears randomly over the entire image. But in contrary to quantization noise like speckle, which is connected to the signal power, thermal noise is hardly noticeable. Therefore high impact of thermal noise on the quality of the data is especially given in areas like calm lakes, rivers and others with a low mean signal response detected by the SAR system. For the purpose of correction the IPF is calculating a thermal noise Look up Table (LUT) which is stored within the Sentinel-1 Level-1 product. More information about the calculation of the thermal noise for Sentinel-1 is given in :cite:`Sentinel1ProductDefinition`.


Practical implementation
~~~~~~~~~~~~~~~~~~~~~~~~~
The Thermal Noise Removal operator of SNAP S1TBX software is used to remove the thermal noise which is stored within a LUT inside of Level-1 products. This operation can only applied on backscatter intensity by which the phase information of the SLC data is lost.

Input:
    - Sentinel-1 SLC IW image with updated orbit information

Output:
    - Sentinel-1 SLC Intensity corrected by thermal noise

.. _radiometric_calibration:

Radiometric calibration
-------------------------
Theory / Purpose
~~~~~~~~~~~~~~~~~~
Sentinel-1 Level-1 products are not radiometric corrected by default. However, for the quantitative use of SAR images a radiometric calibration of radar reflectivity (stored as Digital Numbers (DN) within Sentinel-1 Level-1 products) to physical units (radar backscatter) is essential. Otherwise a comparison of SAR images from different sensors or even the same sensor for different acquisition dates or different acquisition modes is not possible. To apply a radiometric calibration a Calibration Annotation Data Set (CADS) with four Look Up Tables (LUTs) are provided within the Sentinel-1 Level-1 products by Sentinel-1 instrument Processing Facility (IPF). The four LUTs are used to convert DN to sigma naught, beta naught and gamma or vice versa. More information about the radiometric calibration is given in :cite:`Miranda`.


.. code::

    ??? equations ???


Practical implementation
~~~~~~~~~~~~~~~~~~~~~~~~~
The radiometric calibration operator of SNAP S1TBX software is used to perform the conversion of DN to radar backscatter. In our case the output radar backscatter information from S1TBX calibration operator are calibrated ???beta naught why??? backscatter values.

Input:
    - ???

Output:
    -


TOPSAR Deburst
---------------
Theory / Purpose
~~~~~~~~~~~~~~~~~
Sentinel-1 Level-1 SLC images acquired in Interferometric Wide (IW) or Extra-Wide (EW) swath mode consists of one image per swath and polarisation. IW products are made up of three swaths which means three images for single polarisation and six images for dual polarisation. EW products are made up of five swaths which means five images for single polarisation and ten images for dual polarisation.

.. code::

    "Each sub-swath image consists of a series of bursts, where each burst was processed as a separate SLC image. The individually focused complex burst images are included, in azimuth-time order, into a single sub-swath image, with black-fill demarcation in between, similar to the ENVISAT ASAR Wide ScanSAR SLC products." wörtliches Zitat ??????!!!!! :cite:`Sentinel1Team`

For the usage of Sentinel-1 Level-1 SLC data only one sub-swath can be extracted or several/all sub-swath can be combined to one image with fluent transitions between the sub-swaths.

More detailed information are provided in :cite:`Sentinel1Team`, :cite:`d2007burst` and :cite:`de2006topsar`.


Practical implementation
~~~~~~~~~~~~~~~~~~~~~~~~~
The TOPSAR-Deburst operator of SNAP S1TBX software is used to merge all sub-swath to get one entire image.

Input:
    - radiometric calibrated (... naught) SLC image consisting of different sub-swaths.

Output:
    -


Geometric correction
---------------------
Theory / Purpose
~~~~~~~~~~~~~~~~~
A important part of the preprocessing chain is the geometric terrain correction. The geometric correction is a conversion of the Sentinel-1 SLC data from slant range geometry into a map coordinate system. Due to the acquisition geometry of the SAR different topographical distortions like foreshortening, layover or shadowing effects occur. The appropriate way to correct these distortions is the Range-Doppler approach. The method needs information about the topography ( normally provided by a Digital Elevation Model (DEM)) as well as orbit and velocity information from the satellite (stored within Sentinel-1 SLC data) to correct the mentioned distortions and derive a precise geolocation for each pixel of the image.

Practical implementation
~~~~~~~~~~~~~~~~~~~~~~~~~
A geometric correction of the input data is performed by using the "Range Doppler Terrain Correction" method implement in SNAP's S1TBX software. Data from the Shuttle Radar Topography Mission (SRTM) with a resolution of 1-arc second (30 meters) is used for the necessary DEM.

Input:
    - ???
    - SRTM 1-arc second resolution (automatic download)


Output:
    - ???

Radiometric correction
---------------------------------------
Theory / Purpose
~~~~~~~~~~~~~~~~~
For the conversion of Sentinel-1 backscatter values to sigma or gamma naught geometry, LUT's stored within the Sentinel-1 product are used (see :ref:`radiometric_calibration`). For the creation of the LUT's the Sentinel-1 IPF are using an incidence angle of an ellipsoid inflated earth model :cite:`Miranda`. Therefore, the local terrain variation within the image and their radiometric impact on the backscatter is considered insufficiently. A simple and widely used practice to consider the radiometric impact due to local terrain variations represents the approach to use the local incidence angle instead of the ellipsoid one :cite:`kellndorfer`. The radiometric corrected backscatter :math:`\sigma_{NORLIM}^{0}` used by Kellndorfer et al. :cite:`kellndorfer` can be calculated as

.. math::
    \sigma_{NORLIM}^{0} = \sigma_{Ell} \frac{sin \theta_{LIA}}{sin \theta_{Ell}}
    :label: kellndorfer

with :math:`\theta_{LIA}` as the local incidence angle and :math:`\theta_{Ell}` as the ellipsoid incidence angle used by IPF.

.. code::

    write part about: problem in areas with significant topography based on David Small's paper. Also mention that the algorithm is not accurate implemented in SNAP!

Practical implementation
~~~~~~~~~~~~~~~~~~~~~~~~~
Within the "Range Doppler Terrain Correction" method of SNAP's S1TBX software the radiometric normalisation approach of Kellndorfer et al. :cite:`kellndorfer` is implemented as a additional option. Unfortunately the SNAP internal option can not be used with our kind of data. Therefore, normalisation after :cite:`kellndorfer` is done by coding the equations within the BandMath operator of SNAP's S1TBX. The used local incidence angle is provided by the previous applied "Range Doppler Terrain Correction" function and therefore the local incidence angle is based on the SRTM data.

Input:
    - ???
    - Local incidence angle (stored within the data through "Range Doppler Terrain Correction" operator and therefore based on SRTM data)

Output:
    - ???

Backscatter normalisation
-------------------------
Theory / Purpose
~~~~~~~~~~~~~~~~~
Beside the previously discussed geometric and radiometric distortions some other specific backscattering coefficient variations within the range direction of the image are caused by the image geometry of the SAR sensor. The backscattered energy of an illuminated area has not only a dependency on the area itself but also on the incidence angle. This means, backscatter values of a specific area with a small incidence angle return higher backscatter values then data of the same area acquired with higher incidence angles. Incidence angle induced variations not only occur inside one image but also between images form different sensors as well as within one sensor through different acquisition geometries or different tracks or orbits. For a usage of Sentinel-1A and 1B time-series acquired on different orbits and/or different tracks a backscatter normalisation is vital. A often and widely used technique to minimize backscatter variations caused by the incidence angle is the cosine correction :cite:`ulaby1982microwave`. The cosine correction is based on the Lambert's law for optics. Therefore under the assumption that the backscattered energy in the upper hemisphere follows a cosine law and also the radiation variability has a cosine dependency, the received backscatter :math:`\sigma_{\theta_i}^{0}` is dependent on the incidence angle can then written as

.. math::
    \sigma_{\theta_i}^{0} = \sigma_0^{0}cos^{n}(\theta_i)
    :label: cosine_1

with a weighting factor n and the incidence angle independent backscatter :math:`\sigma_{0}^{0}`.
With the cosine correction the backscatter of the Sentinel-1 products can therefore normalised to a reference angle :math:`\theta_{ref}` with

.. math::
    \sigma_{ref}^{0} = \frac{\sigma_{\theta_i}^{0}cos^{n}(\theta_{ref})}{cos^{n}_{\theta_i}}
    :label: cosine_2

.. code::

    Figure from wagner 1999, n dependent on roughness

Practical implementation
~~~~~~~~~~~~~~~~~~~~~~~~~
The backscatter normlisation is applied by coding :eq:`cosine_2` in SNAP's S1TBX operator "BandMaths". As default a reference angle of 35° and a weighting factor of 2 is specified. Through a configuration file the user can replace the default values with for their own case probably more suitable values.


Input:
    -
    - reference angle (default is 35°)
    - weighting factor (default is 2)

Output:
    -

Co-registration
----------------
Theory / Purpose
~~~~~~~~~~~~~~~~~
For time-series analysis especially when applying a :ref:`multi_temporal_speckle_filter` the SAR image has to be co-registered. The co-registration is a method to get every image of the time-series on the same grid with also the pixel resolution.

More about the actual process how it is done by in SNAP?

Practical implementation
~~~~~~~~~~~~~~~~~~~~~~~~~
The co-registration as a requirement for the :ref:`multi_temporal_speckle_filter` is done by the co-registration operator within SNAP's S1TBX. The co-registration operator in SNAP is defined as a completely automatic process. The operator consists of a stack creation (collocating master and slave image), a cross correlation (allignment between master ans slave image) and a warp (resamples pixels from the slave image to pixels of the master image).

Input:
    - Master image
    - Slave image(s)

Output:
    - Co-registered images

.. _multi_temporal_speckle_filter:

Multi-temporal speckle filter
-----------------------------

Theory / Purpose
~~~~~~~~~~~~~~~~~
A characteristic of images acquired with a SAR system is the visibility of random noise which look like "salt and pepper" within the image and is called speckle. The appearance of speckle is caused by the interferences of coherent echoes from individual scatterers within one pixel :cite:`woodhouse2005introduction`.The presence of speckle degrades the quality of the image and therefore it makes the interpretation of the SAR data more difficult. Over the years several approaches for speckle reduction were developed. They are mainly based on either multi-looking or filtering methods. Different filtering approaches like Frost, Lee etc. can be applied as a single or multi-temporal speckle filter. First results with Sentinel-1 data show that a multi-temporal speckle filter provides better results in form of speckle reduction and resolution preservation then a single speckle filter. A major advantage for the usage of a multi-temporal speckle filter is the high temporal resolution of Sentinel-1 data. Nevertheless more detailed studies to analyse the effect from different multi-temporal speckle filter on Sentinel-1 data with respect to applications on vegetation and surface parameters has to be carried out. Anyway a usage of a multi-temporal filter significantly reduces the speckle and is therefore a part of our preprocessing chain.

Practical implementation
~~~~~~~~~~~~~~~~~~~~~~~~~
For the speckle reduction the multi-temporal speckle filter operator within SNAP's S1TBX software is used. Currently 15 temporally consecutive images are used within multi-temporal speckle filter whereby the target image is temporally situated in the middle. The applied filter is a Lee filter with spatial averaging over 5x5 pixel. If the image consists of two polarisations the filter is applied on each polarisation separately. The practical implementation in case of filter type, used polarisation, number of used images etc. may change with more experience of applying multi-temporal speckle filters and their results.

Input:
    - 15 co-registered images

Output:
    - speckle filtered images



Credits and References
-----------------------

.. code::

    to be filled



.. rubric:: References
.. bibliography:: references.bib
    :style: unsrt



